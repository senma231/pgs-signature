<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç»œè¿æ¥æµ‹è¯• - Email Signature Generator</title>
    
    <!-- APIé…ç½® -->
    <meta name="api-url" content="https://signature-api.gp96123.workers.dev/api">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .test-result {
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            font-family: monospace;
        }
        .success { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .error { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .warning { background-color: #fefce8; color: #ca8a04; border: 1px solid #fef3c7; }
        .info { background-color: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-3xl font-bold text-center mb-8">ğŸŒ ç½‘ç»œè¿æ¥è¯Šæ–­å·¥å…·</h1>
        
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ ç¯å¢ƒä¿¡æ¯</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div><strong>å½“å‰åŸŸå:</strong> <span id="hostname"></span></div>
                <div><strong>ç”¨æˆ·ä»£ç†:</strong> <span id="userAgent"></span></div>
                <div><strong>ç½‘ç»œçŠ¶æ€:</strong> <span id="networkStatus"></span></div>
                <div><strong>APIåœ°å€:</strong> <span id="apiUrl"></span></div>
            </div>
        </div>

        <!-- æµ‹è¯•æŒ‰é’® -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ§ª è¿æ¥æµ‹è¯•</h2>
            <div class="flex flex-wrap gap-4">
                <button id="testBasic" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                    åŸºç¡€è¿æ¥æµ‹è¯•
                </button>
                <button id="testCors" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                    CORSæµ‹è¯•
                </button>
                <button id="testTimeout" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">
                    è¶…æ—¶æµ‹è¯•
                </button>
                <button id="clearResults" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                    æ¸…ç©ºç»“æœ
                </button>
            </div>
        </div>

        <!-- æµ‹è¯•ç»“æœ -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š æµ‹è¯•ç»“æœ</h2>
            <div id="testResults" class="space-y-2">
                <div class="info test-result">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–é¡µé¢ä¿¡æ¯
        function initializeInfo() {
            document.getElementById('hostname').textContent = window.location.hostname;
            document.getElementById('userAgent').textContent = navigator.userAgent.substring(0, 80) + '...';
            document.getElementById('networkStatus').textContent = navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿';
            
            const apiUrl = document.querySelector('meta[name="api-url"]')?.content || 'æœªé…ç½®';
            document.getElementById('apiUrl').textContent = apiUrl;
        }

        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addResult(message, type = 'info') {
            const container = document.getElementById('testResults');
            const result = document.createElement('div');
            result.className = `test-result ${type}`;
            result.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(result);
            container.scrollTop = container.scrollHeight;
        }

        // æ¸…ç©ºç»“æœ
        function clearResults() {
            document.getElementById('testResults').innerHTML = 
                '<div class="info test-result">ç»“æœå·²æ¸…ç©ºï¼Œç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹æ–°çš„æµ‹è¯•...</div>';
        }

        // åŸºç¡€è¿æ¥æµ‹è¯•
        async function testBasicConnection() {
            addResult('å¼€å§‹åŸºç¡€è¿æ¥æµ‹è¯•...', 'info');
            
            const apiUrl = document.querySelector('meta[name="api-url"]').content;
            const testUrl = apiUrl + '/health';
            
            try {
                addResult(`æµ‹è¯•URL: ${testUrl}`, 'info');
                
                const startTime = Date.now();
                const response = await fetch(testUrl, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit'
                });
                const endTime = Date.now();
                
                addResult(`å“åº”æ—¶é—´: ${endTime - startTime}ms`, 'info');
                addResult(`HTTPçŠ¶æ€: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'error');
                
                const contentType = response.headers.get('content-type');
                addResult(`å†…å®¹ç±»å‹: ${contentType}`, 'info');
                
                if (response.ok) {
                    if (contentType && contentType.includes('application/json')) {
                        const data = await response.json();
                        addResult(`âœ… åŸºç¡€è¿æ¥æµ‹è¯•æˆåŠŸ`, 'success');
                        addResult(`å“åº”æ•°æ®: ${JSON.stringify(data)}`, 'success');
                    } else {
                        addResult(`âš ï¸ å“åº”ä¸æ˜¯JSONæ ¼å¼`, 'warning');
                        const text = await response.text();
                        addResult(`å“åº”å†…å®¹: ${text.substring(0, 100)}...`, 'warning');
                    }
                } else {
                    addResult(`âŒ HTTPé”™è¯¯: ${response.status}`, 'error');
                }
                
            } catch (error) {
                addResult(`âŒ åŸºç¡€è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                
                // è¯¦ç»†é”™è¯¯åˆ†æ
                if (error.name === 'TypeError' && error.message.includes('CORS')) {
                    addResult(`ğŸš« CORSé”™è¯¯ - å¯èƒ½æ˜¯æœåŠ¡å™¨æœªæ­£ç¡®é…ç½®CORSå¤´`, 'error');
                } else if (error.message.includes('ERR_CONNECTION_TIMED_OUT')) {
                    addResult(`â° è¿æ¥è¶…æ—¶ - å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡å™¨æ— å“åº”`, 'error');
                } else if (error.message.includes('ERR_NAME_NOT_RESOLVED')) {
                    addResult(`ğŸŒ DNSè§£æå¤±è´¥ - è¯·æ£€æŸ¥åŸŸåæ˜¯å¦æ­£ç¡®`, 'error');
                }
            }
        }

        // CORSä¸“é¡¹æµ‹è¯•
        async function testCors() {
            addResult('å¼€å§‹CORSä¸“é¡¹æµ‹è¯•...', 'info');
            
            const apiUrl = document.querySelector('meta[name="api-url"]').content;
            const testUrl = apiUrl + '/health';
            
            // æµ‹è¯•ä¸åŒçš„CORSé…ç½®
            const corsConfigs = [
                { mode: 'cors', credentials: 'omit', name: 'æ ‡å‡†CORS' },
                { mode: 'cors', credentials: 'include', name: 'åŒ…å«å‡­æ®çš„CORS' },
                { mode: 'no-cors', name: 'æ— CORSæ¨¡å¼' }
            ];
            
            for (const config of corsConfigs) {
                try {
                    addResult(`æµ‹è¯• ${config.name}...`, 'info');
                    
                    const response = await fetch(testUrl, {
                        method: 'GET',
                        mode: config.mode,
                        credentials: config.credentials || 'omit'
                    });
                    
                    if (config.mode === 'no-cors') {
                        addResult(`${config.name}: è¯·æ±‚å·²å‘é€ï¼ˆæ— æ³•è¯»å–å“åº”ï¼‰`, 'warning');
                    } else {
                        addResult(`${config.name}: ${response.status} ${response.statusText}`, 
                            response.ok ? 'success' : 'warning');
                    }
                    
                } catch (error) {
                    addResult(`${config.name} å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        // è¶…æ—¶æµ‹è¯•
        async function testTimeout() {
            addResult('å¼€å§‹è¶…æ—¶æµ‹è¯•...', 'info');
            
            const apiUrl = document.querySelector('meta[name="api-url"]').content;
            const testUrl = apiUrl + '/health';
            
            // æµ‹è¯•ä¸åŒçš„è¶…æ—¶è®¾ç½®
            const timeouts = [5000, 10000, 15000]; // 5ç§’, 10ç§’, 15ç§’
            
            for (const timeout of timeouts) {
                try {
                    addResult(`æµ‹è¯• ${timeout}ms è¶…æ—¶...`, 'info');
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), timeout);
                    
                    const startTime = Date.now();
                    const response = await fetch(testUrl, {
                        method: 'GET',
                        mode: 'cors',
                        credentials: 'omit',
                        signal: controller.signal
                    });
                    const endTime = Date.now();
                    
                    clearTimeout(timeoutId);
                    
                    addResult(`${timeout}ms è¶…æ—¶æµ‹è¯•æˆåŠŸï¼Œå®é™…ç”¨æ—¶: ${endTime - startTime}ms`, 'success');
                    
                } catch (error) {
                    if (error.name === 'AbortError') {
                        addResult(`${timeout}ms è¶…æ—¶æµ‹è¯•: è¯·æ±‚è¢«ä¸­æ­¢ï¼ˆè¶…æ—¶ï¼‰`, 'warning');
                    } else {
                        addResult(`${timeout}ms è¶…æ—¶æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                    }
                }
            }
        }

        // ç»‘å®šäº‹ä»¶
        document.getElementById('testBasic').addEventListener('click', testBasicConnection);
        document.getElementById('testCors').addEventListener('click', testCors);
        document.getElementById('testTimeout').addEventListener('click', testTimeout);
        document.getElementById('clearResults').addEventListener('click', clearResults);

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializeInfo);

        // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
        window.addEventListener('online', () => {
            addResult('ç½‘ç»œè¿æ¥å·²æ¢å¤', 'success');
            document.getElementById('networkStatus').textContent = 'åœ¨çº¿';
        });

        window.addEventListener('offline', () => {
            addResult('ç½‘ç»œè¿æ¥å·²æ–­å¼€', 'error');
            document.getElementById('networkStatus').textContent = 'ç¦»çº¿';
        });
    </script>
</body>
</html>
