<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIè¿æ¥æµ‹è¯• - Email Signature Generator</title>

    <!-- APIé…ç½® - ä½¿ç”¨è‡ªå®šä¹‰åŸŸåè§£å†³ä¸­å›½å¤§é™†è®¿é—®é—®é¢˜ -->
    <meta name="api-url" content="https://sign-api.pgs-log.cn/api">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry {
            margin: 4px 0;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .log-info { background-color: #e3f2fd; color: #1565c0; }
        .log-success { background-color: #e8f5e8; color: #2e7d32; }
        .log-warning { background-color: #fff3e0; color: #f57c00; }
        .log-error { background-color: #ffebee; color: #c62828; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-center mb-8">ğŸ”§ APIè¿æ¥æµ‹è¯•å·¥å…·</h1>

            <!-- é…ç½®ä¿¡æ¯ -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ“‹ å½“å‰é…ç½®ä¿¡æ¯</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å½“å‰åŸŸå</label>
                        <div id="current-hostname" class="mt-1 p-2 bg-gray-50 rounded border"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Metaæ ‡ç­¾APIåœ°å€</label>
                        <div id="meta-api-url" class="mt-1 p-2 bg-gray-50 rounded border"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å®é™…ä½¿ç”¨çš„APIåœ°å€</label>
                        <div id="actual-api-url" class="mt-1 p-2 bg-gray-50 rounded border"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ç½‘ç»œçŠ¶æ€</label>
                        <div id="network-status" class="mt-1 p-2 bg-gray-50 rounded border"></div>
                    </div>
                </div>
            </div>

            <!-- æµ‹è¯•æŒ‰é’® -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ§ª APIæµ‹è¯•</h2>
                <div class="flex flex-wrap gap-4">
                    <button id="test-health" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                        å¥åº·æ£€æŸ¥
                    </button>
                    <button id="test-companies" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                        è·å–å…¬å¸æ•°æ®
                    </button>
                    <button id="test-direct" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
                        ç›´æ¥è®¿é—®API
                    </button>
                    <button id="clear-logs" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                        æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
            </div>

            <!-- è‡ªå®šä¹‰APIåœ°å€æµ‹è¯• -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ”§ è‡ªå®šä¹‰APIåœ°å€æµ‹è¯•</h2>
                <div class="flex gap-4">
                    <input
                        id="custom-api-url"
                        type="text"
                        placeholder="https://your-worker.workers.dev/api"
                        class="flex-1 p-2 border border-gray-300 rounded"
                    >
                    <button id="test-custom" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded">
                        æµ‹è¯•è‡ªå®šä¹‰åœ°å€
                    </button>
                </div>
            </div>

            <!-- æ—¥å¿—è¾“å‡º -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
                <div id="log-container" class="max-h-96 overflow-y-auto border border-gray-200 rounded p-4">
                    <!-- æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <script src="js/cloudflare-api.js"></script>
    <script>
        // æ—¥å¿—è®°å½•å™¨
        class Logger {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
            }

            log(message, type = 'info') {
                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                this.container.appendChild(entry);
                this.container.scrollTop = this.container.scrollHeight;
            }

            info(message) { this.log(message, 'info'); }
            success(message) { this.log(message, 'success'); }
            warning(message) { this.log(message, 'warning'); }
            error(message) { this.log(message, 'error'); }

            clear() {
                this.container.innerHTML = '';
            }
        }

        const logger = new Logger('log-container');

        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
            document.getElementById('current-hostname').textContent = window.location.hostname;
            document.getElementById('meta-api-url').textContent =
                document.querySelector('meta[name="api-url"]')?.content || 'æœªé…ç½®';
            document.getElementById('actual-api-url').textContent = API_CONFIG.baseURL;
            document.getElementById('network-status').textContent =
                navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿';

            logger.info('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            logger.info(`å½“å‰åŸŸå: ${window.location.hostname}`);
            logger.info(`APIåœ°å€: ${API_CONFIG.baseURL}`);
        }

        // å¥åº·æ£€æŸ¥æµ‹è¯•
        async function testHealth() {
            logger.info('å¼€å§‹å¥åº·æ£€æŸ¥æµ‹è¯•...');
            try {
                const client = new CloudflareApiClient();
                const result = await client.healthCheck();
                logger.success(`å¥åº·æ£€æŸ¥æˆåŠŸ: ${JSON.stringify(result)}`);
            } catch (error) {
                logger.error(`å¥åº·æ£€æŸ¥å¤±è´¥: ${error.message}`);
            }
        }

        // å…¬å¸æ•°æ®æµ‹è¯•
        async function testCompanies() {
            logger.info('å¼€å§‹è·å–å…¬å¸æ•°æ®æµ‹è¯•...');
            try {
                const client = new CloudflareApiClient();
                const companies = await client.getCompanies();
                logger.success(`å…¬å¸æ•°æ®è·å–æˆåŠŸ: ${Object.keys(companies).length} å®¶å…¬å¸`);
                logger.info(`å…¬å¸åˆ—è¡¨: ${Object.keys(companies).join(', ')}`);
            } catch (error) {
                logger.error(`å…¬å¸æ•°æ®è·å–å¤±è´¥: ${error.message}`);
            }
        }

        // ç›´æ¥è®¿é—®APIæµ‹è¯•
        async function testDirectAccess() {
            const apiUrl = API_CONFIG.baseURL + '/health';
            logger.info(`ç›´æ¥è®¿é—®API: ${apiUrl}`);

            try {
                const response = await fetch(apiUrl);
                logger.info(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                logger.info(`å“åº”å¤´: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`);

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    logger.success(`JSONå“åº”: ${JSON.stringify(data)}`);
                } else {
                    const text = await response.text();
                    logger.warning(`éJSONå“åº”: ${text.substring(0, 200)}...`);
                }
            } catch (error) {
                logger.error(`ç›´æ¥è®¿é—®å¤±è´¥: ${error.message}`);
            }
        }

        // è‡ªå®šä¹‰APIåœ°å€æµ‹è¯•
        async function testCustomApi() {
            const customUrl = document.getElementById('custom-api-url').value.trim();
            if (!customUrl) {
                logger.warning('è¯·è¾“å…¥è‡ªå®šä¹‰APIåœ°å€');
                return;
            }

            logger.info(`æµ‹è¯•è‡ªå®šä¹‰APIåœ°å€: ${customUrl}`);

            try {
                const response = await fetch(customUrl + '/health');
                logger.info(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    logger.success(`è‡ªå®šä¹‰APIæµ‹è¯•æˆåŠŸ: ${JSON.stringify(data)}`);
                } else {
                    const text = await response.text();
                    logger.warning(`è‡ªå®šä¹‰APIè¿”å›éJSON: ${text.substring(0, 200)}...`);
                }
            } catch (error) {
                logger.error(`è‡ªå®šä¹‰APIæµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        // ç»‘å®šäº‹ä»¶
        document.getElementById('test-health').addEventListener('click', testHealth);
        document.getElementById('test-companies').addEventListener('click', testCompanies);
        document.getElementById('test-direct').addEventListener('click', testDirectAccess);
        document.getElementById('test-custom').addEventListener('click', testCustomApi);
        document.getElementById('clear-logs').addEventListener('click', () => logger.clear());

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializePage);

        // é‡å†™console.logä»¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;

        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            logger.info(args.join(' '));
        };

        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            logger.warning(args.join(' '));
        };

        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            logger.error(args.join(' '));
        };
    </script>
</body>
</html>
